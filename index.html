<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Text Cleaner</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; margin: 12px; }
  h1 { font-size: 18px; margin: 8px 0 12px; }
  textarea { width: 100%; min-height: 220px; }
  .row { margin: 10px 0; }
  button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ccc; }
  .muted { color: #666; font-size: 12px; }

  /* Output khusus agar seleksi hanya di sini */
  #outContainer {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px;
    min-height: 180px;
    background: #fafafa;
  }
  #out {
    white-space: pre-wrap;
    user-select: text;
    -webkit-user-select: text;
  }
</style>
</head>
<body>
  <h1>Text Cleaner</h1>

  <div class="row">
    <label for="inp"><b>Input (≤ 3000 kata)</b></label><br/>
    <textarea id="inp" placeholder="Tempel teks di sini..."></textarea>
    <div class="muted" id="wc">0 kata</div>
  </div>

  <div class="row">
    <button id="btn">Proses</button>
    <button id="btnCopy" type="button">Copy Output</button>
    <button id="btnSelect" type="button">Select Output</button>
    <span id="status" class="muted"></span>
  </div>

  <div class="row">
    <label><b>Output</b></label>
    <div id="outContainer"><div id="out"></div></div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const inp = $("inp"), out = $("out"), wc = $("wc"), status = $("status");

  function countWords(s){
    const m=(s||"").trim().match(/\S+/g);
    return m ? m.length : 0;
  }

  function updateCounter(){
    wc.textContent = countWords(inp.value) + " kata";
  }
  inp.addEventListener("input", updateCounter);
  updateCounter();

  function processText(text){
    let o = text || "";

    // ===== Bagian pembersihan persis seperti versi offline =====
    // Hilangkan heading markdown (#, ##, ### di awal baris)
    o = o.replace(/^#{1,5}\s+/gm, "");

    // Ganti *** dan ** jadi * (supaya italic/bold markdown jadi 1 tanda saja)
    o = o.replace(/\*\*\*/g, "*");
    o = o.replace(/\*\*/g, "*");

    // Ganti garis pemisah '---' di satu baris menjadi '_____'
    o = o.replace(/^\s*---\s*$(\r?\n)?/gm, "\n_____\n\n");

    // Ganti dash panjang / strip di tengah kalimat jadi koma
    o = o.replace(/—/g, ", ");
    o = o.replace(/ - /g, ", ");

    // Hilangkan backslash yang tidak perlu
    o = o.replace(/\\\$/g, "$");  // \$  -> $
    o = o.replace(/\\/g, "");     // sisa backslash lain dibuang

    // Batasi baris kosong maksimum 2
    o = o.replace(/((\r?\n)[ \t]*){3,}/g, "\n\n");

    return o;
  }

  $("btn").addEventListener("click", ()=>{
    const words = countWords(inp.value);
    if (words > 3000) {
      status.textContent = `Input ~${words} kata. Batas 3000.`;
      return;
    }
    out.textContent = processText(inp.value);
    status.textContent = "Selesai.";
  });

  // Copy yang kompatibel di HTTPS (GitHub Pages) + fallback
  async function copyOutput() {
    const text = out.textContent || "";
    if (!text) {
      status.textContent = "Output kosong.";
      return;
    }

    // 1) Clipboard API (berfungsi di GitHub Pages karena HTTPS)
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        status.textContent = "Output disalin (clipboard API).";
        return;
      }
      throw new Error("Not secure context");
    } catch (_) {}

    // 2) Fallback: hidden textarea + execCommand('copy')
    try {
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "absolute";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      status.textContent = ok ? "Output disalin (fallback)." : "Gagal menyalin.";
    } catch (e) {
      status.textContent = "Gagal menyalin.";
    }
  }

  $("btnCopy").addEventListener("click", copyOutput);

  // Convenience: select only the output area
  $("btnSelect").addEventListener("click", ()=>{
    const range = document.createRange();
    range.selectNodeContents(out);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    status.textContent = "Output dipilih. Tap 'Copy' di toolbar.";
  });

  // Optional: tap sekali pada area output -> auto select konten
  $("out").addEventListener("click", ()=>{
    const range = document.createRange();
    range.selectNodeContents(out);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  });
</script>
</body>
</html>
